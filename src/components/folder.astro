---
import Heading from "./Heading.astro"

---
<div class="w-full max-w-screen overflow-hidden">
  <section
    id="steps"
    class="flex flex-col md:flex-row gap-4 md:gap-6 w-full md:h-[40vw] h-auto"
  >
    <!-- Step 1 -->
    <div
      class="step group bg-orange text-black p-4 md:p-6 border border-transparent md:flex-1 min-w-0 min-h-0 overflow-hidden transition-[flex-grow,flex-basis] duration-500 ease-in-out"
      data-step="1"
      role="button"
      tabindex="0"
      aria-expanded="false"
    >
      <div class="flex items-center justify-between cursor-pointer select-none">
        <h3 class="text-lg md:text-xl font-bold">Step 1</h3>
        <span class="md:hidden text-sm opacity-70">tap to open</span>
      </div>

      <div
        class="content pointer-events-none md:pointer-events-auto bg-white border border-orange mt-3 md:mt-4 overflow-hidden max-h-0 md:max-h-none md:h-0 hidden md:block transition-[max-height] duration-500 ease-in-out"
      >
        <div class="p-4 md:p-5 text-sm leading-relaxed text-black text-center">
          Take a photo of your instant with your smartphone (or scan it for max. quality) – the file
          should be between 2–10 MB, in jpg/jpeg or webp format.
          <img
            class="mt-3 block mx-auto object-contain w-full max-w-[20rem] md:max-w-[22rem] h-auto"
            src="/images/step1.svg"
            alt="First step illustration"
          />
        </div>
      </div>
    </div>

    <!-- Step 2 -->
    <div
      class="step group bg-dgrey text-white p-4 md:p-6 border border-transparent md:flex-1 min-w-0 min-h-0 overflow-hidden transition-[flex-grow,flex-basis] duration-500 ease-in-out"
      data-step="2"
      role="button"
      tabindex="0"
      aria-expanded="false"
    >
      <div class="flex items-center justify-between cursor-pointer select-none">
        <h3 class="text-lg md:text-xl font-bold">Step 2</h3>
        <span class="md:hidden text-sm opacity-70">tap to open</span>
      </div>

      <div
        class="content pointer-events-none md:pointer-events-auto bg-white border border-dgrey mt-3 md:mt-4 overflow-hidden max-h-0 md:max-h-none md:h-0 hidden md:block transition-[max-height] duration-500 ease-in-out"
      >
        <div class="p-4 md:p-5 text-sm leading-relaxed text-black text-center">
          Upload your photo and credentials
          <a href="/shareyourinstant" class="underline font-medium">Share here</a>.
          <img
            class="mt-3 block mx-auto object-contain w-full max-w-[20rem] md:max-w-[22rem] h-auto"
            src="/images/step2.svg"
            alt="Second step illustration"
          />
        </div>
      </div>
    </div>

    <!-- Step 3 -->
    <div
      class="step group bg-pink text-black p-4 md:p-6 border border-transparent md:flex-1 min-w-0 min-h-0 overflow-hidden transition-[flex-grow,flex-basis] duration-500 ease-in-out"
      data-step="3"
      role="button"
      tabindex="0"
      aria-expanded="false"
    >
      <div class="flex items-center justify-between cursor-pointer select-none">
        <h3 class="text-lg md:text-xl font-bold">Step 3</h3>
        <span class="md:hidden text-sm opacity-70">tap to open</span>
      </div>

      <div
        class="content pointer-events-none md:pointer-events-auto bg-white border border-pink mt-3 md:mt-4 overflow-hidden max-h-0 md:max-h-none md:h-0 hidden md:block transition-[max-height] duration-500 ease-in-out"
      >
        <div class="p-4 md:p-5 text-sm leading-relaxed text-black text-center">
          Agree to our terms and conditions (link on the “share your instants” page). Short version:
          participants must be 18+, portrayed persons have consented, and you agree your instant can
          be exhibited and used to promote the photo contest.
          <img
            class="mt-3 block mx-auto object-contain w-full max-w-[20rem] md:max-w-[22rem] h-auto"
            src="/images/step3.svg"
            alt="Third step illustration"
          />
        </div>
      </div>
    </div>

    <!-- Step 4 -->
    <div
      class="step group bg-blue text-white p-4 md:p-6 border border-transparent md:flex-1 min-w-0 min-h-0 overflow-hidden transition-[flex-grow,flex-basis] duration-500 ease-in-out"
      data-step="4"
      role="button"
      tabindex="0"
      aria-expanded="false"
    >
      <div class="flex items-center justify-between cursor-pointer select-none">
        <h3 class="text-lg md:text-xl font-bold">Step 4</h3>
        <span class="md:hidden text-sm opacity-70">tap to open</span>
      </div>

      <div
        class="content pointer-events-none md:pointer-events-auto bg-white border border-blue mt-3 md:mt-4 overflow-hidden max-h-0 md:max-h-none md:h-0 hidden md:block transition-[max-height] duration-500 ease-in-out"
      >
        <div class="p-4 md:p-5 text-sm leading-relaxed text-black text-center">
          You can make up to 5 submissions—repeat steps 1–3 for each submission.
          <img
            class="mt-3 block mx-auto object-contain w-full max-w-[20rem] md:max-w-[22rem] h-auto"
            src="/images/step4.svg"
            alt="Fourth step illustration"
          />
        </div>
      </div>
    </div>
  </section>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const container = document.getElementById("steps");
    if (!container) return;

    const steps = Array.from(container.querySelectorAll(".step"));
    const isDesktop = () => window.matchMedia("(min-width: 768px)").matches;

    function measureAndSet(content) {
      content.style.maxHeight = "";
      const target = content.scrollHeight;
      content.style.maxHeight = `${target}px`;
    }

    function closeAll() {
      steps.forEach((step) => {
        step.classList.remove("md:flex-[3]");
        step.classList.add("md:flex-1");
        step.setAttribute("aria-expanded", "false");

        const content = step.querySelector(".content");
        if (!content) return;

        if (isDesktop()) {
          content.classList.add("hidden");
          content.style.height = "0px";
          content.style.maxHeight = "";
        } else {
          content.style.maxHeight = "0px";
        }
      });
    }

    function openStep(step) {
      const content = step.querySelector(".content");
      if (!content) return;

      closeAll();

      step.classList.remove("md:flex-1");
      step.classList.add("md:flex-[3]");
      step.setAttribute("aria-expanded", "true");

      content.classList.remove("hidden");

      if (isDesktop()) {
        content.style.height = "auto";
        content.style.maxHeight = "";
      } else {
        requestAnimationFrame(() => measureAndSet(content));
      }
    }

    function init() {
      if (isDesktop()) {
        openStep(steps[0]);
      } else {
        closeAll();
        steps.forEach((s) => s.querySelector(".content")?.classList.add("hidden"));
      }
    }

    function recalcOpenMobile() {
      if (isDesktop()) return;
      const open = steps.find((s) => s.getAttribute("aria-expanded") === "true");
      const content = open?.querySelector(".content");
      if (content) measureAndSet(content);
    }

    steps.forEach((step) => {
      const onTrigger = (e) => {
        e.preventDefault();
        const expanded = step.getAttribute("aria-expanded") === "true";
        if (expanded) closeAll();
        else openStep(step);
      };

      step.addEventListener("click", onTrigger);
      step.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          onTrigger(e);
        }
      });

      // Recalc if image loads inside this step
      step.querySelectorAll("img").forEach((img) => {
        img.addEventListener("load", () => {
          if (!isDesktop() && step.getAttribute("aria-expanded") === "true") {
            const content = step.querySelector(".content");
            if (content) measureAndSet(content);
          }
        });
      });
    });

    let resizeTimer;
    window.addEventListener("resize", () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        init();
        recalcOpenMobile();
      }, 150);
    });

    init();
  });
</script>